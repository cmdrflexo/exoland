<!doctype html>
<html>
  <body>
    <script src="three.js"></script>
    <script>
let session = null;

const scene = new THREE.Scene();
scene.matrixAutoUpdate = false;

const camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 0.1, 100);
// camera.position.z = 2;

const renderer = new THREE.WebGLRenderer({
  antialias: true,
});
// renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const _startFakeVrDisplay = async (width, height) => {
  fakeXrDisplay = new FakeXRDisplay();
  if (isFinite(width)) {
    fakeXrDisplay.width = width;
  }
  if (isFinite(height)) {
    fakeXrDisplay.height = height;
  }
  fakeXrDisplay.position.set(0, 1.6, 0);
  fakeXrDisplay.pushUpdate();

  if (navigator.xr) {
    session = await navigator.xr.requestSession({
      exclusive: true,
    });
    fakeXrDisplay.session = session;

    const _end = () => {
      renderer.vr.enabled = false;
      renderer.vr.setSession(null);
      renderer.vr.setAnimationLoop(null);

      _emitLayersExitPresent();

      session.removeEventListener('end', _end);
    };
    session.addEventListener('end', _end);

    await new Promise((accept, reject) => {
      session.requestAnimationFrame((timestamp, frame) => {
        session.layers = [renderer.domElement];

        renderer.vr.enabled = true;
        renderer.vr.setSession(session, {
          frameOfReferenceType: 'stage',
        });
        renderer.vr.setAnimationLoop(animate);

        accept();
      });
    });
  } else {
    const displays = await navigator.getVRDisplays();
    const display = displays[0];
    await display.requestPresent([{
      source: renderer.domElement,
    }]);

    fakeXrDisplay.display = display;

    const _vrdisplaypresentchange = () => {
      _emitLayersExitPresent();

      display.removeEventListener('vrdisplaypresentchange', _vrdisplaypresentchange);
    };
    display.addEventListener('vrdisplaypresentchange', _vrdisplaypresentchange);

    display.layers = layers;

    renderer.vr.enabled = true;
    renderer.vr.setDevice(display);
    renderer.vr.setAnimationLoop(animate);
  }
};
_startFakeVrDisplay()
  .then(() => {
    const _makeIframe = position => {
      const iframe = document.createElement('iframe');
      iframe.d = 2;
      iframe.src = 'https://google.com';
      iframe.position = position;
      return iframe;
    };

    session.layers.push(_makeIframe([1.5, 1, -2]));
    session.layers.push(_makeIframe([-1.5, 1, -2]));

    console.log('loaded fake display');
  })
  .catch(err => {
    console.warn(err.stack);
  });
function animate() {
  renderer.render(scene, renderer.vr.enabled ? renderer.vr.getCamera(camera) : camera);
}
    </script>
  </body>
</html>
